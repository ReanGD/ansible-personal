---
- name: Custom setup
  setup:
    gather_subset:
      - '!all'
      - '!any'

- name: Find distro name
  shell: cat /etc/os-release | grep "^ID=" | cut -d'=' -f2-
  register: reg_distro
  changed_when: false

- name: Set common facts
  set_fact:
    main_user: rean
    install_user: aur_builder
    is_chroot: "{{ is_chroot_param }}"
    root_dir: "{{ inventory_dir }}"
    packages_dir: "{{ inventory_dir }}/common/files"
    x86_64: "{{ ansible_facts['architecture'] == 'x86_64' }}"
    arm: "{{ansible_facts['architecture'] == 'armv7l'}}"
    distro: "{{reg_distro.stdout}}"

- name: Find board uuid for x86_64
  shell: cat /sys/class/dmi/id/product_name
  register: reg_product_name_x86_64
  changed_when: false
  become: yes
  when: x86_64

- name: Find board uuid for armv7l
  shell: grep -Po '^Serial\s*:\s*\K[[:xdigit:]]{16}' /proc/cpuinfo
  register: reg_product_name_armv7l
  changed_when: false
  when: arm

# distro: "arch" or "archarm" or "manjaro"
# network_type: "lan" or ""lan_old" or "wifi"
# virtualization: "none" or "kvm_qemu" or "kvm_libvirt"
# gui: "none" or ["lightdm", "awesome", "cinnamon", "notebook"]
# develop: "none" or ["std", "cpp", "python", "go", "rust", "rust3D", "protobuf", "sqlite", "android"]
# monitoring: "none" or ["std", "notebook", "hddtemp", "ups"]
# roles: "none" or ["font", "docker", "automount", "web", "game", "messengers", "media", "plex", "repository", "dotfiles"]

- name: Set archhost facts
  set_fact:
    hostname_id: "archhost"
    add_dop_user: False
    network_type: "lan"
    set_ssh_access_keys: True
    virtualization: "kvm_qemu"
    gui: "lightdm,awesome"
    develop: "std,cpp,python,go,protobuf"
    monitoring: "std,hddtemp"
    roles: "font,docker,automount,web,game,messengers,media,repository,dotfiles"
    nvram_write_enble: False
    swap_size: 35
    swappiness: 1
    packages_file: "{{packages_dir}}/packages.py"
  when: x86_64 and reg_product_name_x86_64.stdout == 'MS-7978'

- name: Set archnote facts (xiaomi)
  set_fact:
    hostname_id: "archnote"
    add_dop_user: True
    network_type: "wifi"
    set_ssh_access_keys: True
    virtualization: "none"
    gui: "lightdm,awesome,cinnamon,notebook"
    develop: "std,cpp,python,go,protobuf"
    monitoring: "std,notebook,hddtemp"
    roles: "font,docker,automount,web,game,messengers,media,repository,dotfiles"
    nvram_write_enble: False
    swap_size: 8
    swappiness: 20
    packages_file: "{{packages_dir}}/packages.py"
  when: x86_64 and reg_product_name_x86_64.stdout == 'TM1613'

- name: Set archsrv facts
  set_fact:
    hostname_id: "archsrv"
    add_dop_user: False
    network_type: "lan"
    set_ssh_access_keys: False
    virtualization: "none"
    gui: "none"
    develop: "none"
    monitoring: "std,hddtemp"
    roles: "docker,automount,plex"
    nvram_write_enble: True
    swap_size: 35
    swappiness: 1
    packages_file: "{{packages_dir}}/packages.py"
  when: x86_64 and reg_product_name_x86_64.stdout == 'System Product Name'

- name: Set hass facts
  set_fact:
    hostname_id: "hass"
    add_dop_user: False
    network_type: "lan_old"
    set_ssh_access_keys: False
    virtualization: "none"
    gui: "none"
    develop: "none"
    monitoring: "std,hddtemp"
    roles: "none"
    nvram_write_enble: True
    swap_size: 1
    swappiness: 1
    packages_file: "{{packages_dir}}/packages_hass.py"
  when: arm and reg_product_name_armv7l.stdout == '00000000bed57e85'

- name: Set KVM test facts
  set_fact:
    hostname_id: "kvm_test"
    distro: "manjaro"
    add_dop_user: False
    network_type: "lan"
    set_ssh_access_keys: True
    virtualization: "none"
    gui: "lightdm,awesome"
    develop: "std,cpp,python,go,protobuf"
    monitoring: "std,hddtemp"
    roles: "font,docker,web,game,messengers,media,repository,dotfiles"
    nvram_write_enble: False
    swap_size: 4
    swappiness: 1
    packages_file: "{{packages_dir}}/packages.py"
  when: x86_64 and reg_product_name_x86_64.stdout == 'Standard PC (Q35 + ICH9, 2009)'
